<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ClipByNaim Pro Recorder</title>

<!-- HLS.js -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<!-- Shaka Player -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.compiled.js"></script>

<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:linear-gradient(160deg,#0f2027,#203a43,#2c5364);
  color:#fff;
  text-align:center;
  padding:10px;
}
h2{color:#00ffe7;text-shadow:0 0 10px #00ffe7;}
input,button{
  width:95%;
  padding:14px;
  margin:6px 0;
  border:none;
  border-radius:12px;
}
input{
  background:#111;
  color:#fff;
  box-shadow:0 0 8px #00ffe7;
}
button{font-weight:bold;cursor:pointer;}
#playBtn{background:linear-gradient(90deg,#ff4b1f,#1fddff);}
#recBtn{background:linear-gradient(90deg,#ff1f4b,#ffdf1f);}
#stopBtn{background:linear-gradient(90deg,#fff,#aaa);color:#000;}
video{
  width:100%;
  border-radius:16px;
  margin:12px 0;
  background:#000;
  box-shadow:0 0 20px rgba(0,255,255,0.5);
}
#msg{color:#00ffe7;font-size:14px;margin-top:5px;}
</style>
</head>
<body>

<h2>ClipByNaim Pro Recorder</h2>

<input id="streamUrl" placeholder="Paste .m3u8 Stream URL">
<input id="drmLicense" placeholder="Widevine License URL (Optional)">
<input id="authToken" placeholder="Bearer Token (Optional)">
<button id="playBtn">‚ñ∂ Play Stream</button>
<button id="recBtn">‚óè Start Recording</button>
<button id="stopBtn">‚ñ† Stop Recording</button>

<video id="video" controls playsinline autoplay muted></video>
<p id="msg"></p>

<script>
const video = document.getElementById("video");
const msg = document.getElementById("msg");
const recBtn = document.getElementById("recBtn");

let hls = null;
let shakaPlayer = null;
let mediaRecorder;
let chunks=[];

// ================= PLAY =================
document.getElementById("playBtn").onclick = async () => {

  const url = document.getElementById("streamUrl").value.trim();
  const licenseUrl = document.getElementById("drmLicense").value.trim();
  const token = document.getElementById("authToken").value.trim();

  if(!url){
    alert("Paste stream URL!");
    return;
  }

  msg.innerText="Loading...";

  // Destroy old players
  if(shakaPlayer){
    await shakaPlayer.destroy();
    shakaPlayer=null;
  }
  if(hls){
    hls.destroy();
    hls=null;
  }

  // ========== DRM MODE ==========
  if(licenseUrl){

    shakaPlayer = new shaka.Player(video);

    shakaPlayer.configure({
      drm:{
        servers:{
          'com.widevine.alpha': licenseUrl
        },
        advanced:{
          'com.widevine.alpha':{
            videoRobustness:'SW_SECURE_DECODE',
            audioRobustness:'SW_SECURE_DECODE'
          }
        }
      }
    });

    // Add Bearer Token
    if(token){
      shakaPlayer.getNetworkingEngine().registerRequestFilter(function(type, request){
        if(type == shaka.net.NetworkingEngine.RequestType.LICENSE){
          request.headers['Authorization'] = 'Bearer ' + token;
        }
      });
    }

    try{
      await shakaPlayer.load(url);
      msg.innerText="üîê Playing with Shaka (DRM Enabled)";
    }catch(e){
      console.error(e);
      msg.innerText="‚ùå DRM Stream Failed!";
    }

  }
  // ========== NORMAL HLS MODE ==========
  else{

    if(Hls.isSupported()){
      hls = new Hls({lowLatencyMode:true});
      hls.loadSource(url);
      hls.attachMedia(video);
      msg.innerText="üîµ Playing with HLS.js";
    }else{
      video.src=url;
      msg.innerText="üîµ Native HLS Playing";
    }

  }
};

// ================= RECORD =================
document.getElementById("recBtn").onclick = ()=>{

  if(!video.captureStream){
    alert("Recording not supported in this browser.");
    return;
  }

  recBtn.disabled=true;
  chunks=[];

  let stream = video.captureStream(60);

  mediaRecorder = new MediaRecorder(stream,{
    mimeType:'video/webm;codecs=vp9',
    videoBitsPerSecond:25000000
  });

  mediaRecorder.ondataavailable = e=>chunks.push(e.data);

  mediaRecorder.onstop = ()=>{
    const blob = new Blob(chunks,{type:"video/webm"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href=url;
    a.download="ClipByNaim_"+Date.now()+".webm";
    a.click();
    recBtn.disabled=false;
    msg.innerText="‚¨á Recording Saved!";
  };

  mediaRecorder.start();
  msg.innerText="üî¥ Recording Started...";
};

// ================= STOP =================
document.getElementById("stopBtn").onclick = ()=>{
  if(mediaRecorder) mediaRecorder.stop();
};
</script>

</body>
</html>
